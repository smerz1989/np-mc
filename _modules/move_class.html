

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>move_class &mdash; NP Monolayer Monte Carlo 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> NP Monolayer Monte Carlo
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../inheritance.html">Plot of Module Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coverage.html">Undocumented Python objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simulation_class.html">Simulation Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../move_class.html">Move Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../molecule_class.html">Molecule Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../atom_class.html">Atom Class</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NP Monolayer Monte Carlo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>move_class</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for move_class</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">random</span> <span class="k">as</span> <span class="nn">rnd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">npmc.forcefield_class</span> <span class="k">as</span> <span class="nn">ffc</span>
<span class="kn">import</span> <span class="nn">scipy.special</span> <span class="k">as</span> <span class="nn">scm</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">pi</span><span class="p">,</span><span class="n">acos</span><span class="p">,</span><span class="n">sin</span><span class="p">,</span><span class="n">cos</span>
<span class="kn">import</span> <span class="nn">npmc.molecule_class</span> <span class="k">as</span> <span class="nn">molc</span>

<div class="viewcode-block" id="Move"><a class="viewcode-back" href="../move_class.html#move_class.Move">[docs]</a><span class="k">class</span> <span class="nc">Move</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class used to encapsulate all MC moves that can be used by a simulation.  </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lmp : lammps object</span>
<span class="sd">        The lammps instance associated with the simulation.  Passed in so that the move can evaluate energies of moves and thereby calculate probabilities of acceptance.</span>

<span class="sd">    molecules : list of type Molecule</span>
<span class="sd">        A list of molecules that are available to apply a MC move to.</span>

<span class="sd">    temp : float</span>
<span class="sd">        The temperature of the simulation in Kelvin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">simulation</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span><span class="n">simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">lmp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">molecules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="mf">0.0019872041</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_moves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_accepted</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">get_acceptance_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">acceptance_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_accepted</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_moves</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_moves</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">acceptance_rate</span></div>

<div class="viewcode-block" id="CBMCRegrowth"><a class="viewcode-back" href="../move_class.html#move_class.CBMCRegrowth">[docs]</a><span class="k">class</span> <span class="nc">CBMCRegrowth</span><span class="p">(</span><span class="n">Move</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that encapsulates a Configurationally Biased Regrowth move as outline by Siepmann et al. that inherits from the Move class.  </span>
<span class="sd">    Here the dihedral force fields of the simulation are also passed in to ais in choosing trial positions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dihedral_ffs : list of type DihedralForceField</span>
<span class="sd">        A list of DihedralForceField objects associated with the simulation</span>

<span class="sd">    lmp : lammps object</span>
<span class="sd">        The lammps instance associated with the simulation.  Passed in so that the move can evaluate energies of moves and thereby calculate probabilities of acceptance.</span>

<span class="sd">    molecules : list of type Molecule</span>
<span class="sd">        A list of molecules that are available to apply a MC move to.</span>

<span class="sd">    numtrials : int</span>
<span class="sd">        The number of trial placements used at each step of the regrowth move.  Default is 5 trials.</span>

<span class="sd">    anchortype : int</span>
<span class="sd">        The type number in the LAMMPS file used for the atom type used for the anchor atom in each molecule.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">simulation</span><span class="p">,</span><span class="n">anchortype</span><span class="p">,</span><span class="n">numtrials</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_ffs</span> <span class="o">=</span> <span class="n">ffc</span><span class="o">.</span><span class="n">initialize_dihedral_ffs</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">init_file</span><span class="o">+</span><span class="s1">&#39;.settings&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numtrials</span> <span class="o">=</span> <span class="n">numtrials</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CBMCRegrowth</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anchortype</span> <span class="o">=</span> <span class="n">anchortype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_anchor_atoms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rosen_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Rosenbluth_Data.txt&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rosen_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;log_Wo</span><span class="se">\t</span><span class="s1">log_Wf</span><span class="se">\t</span><span class="s1">probability</span><span class="se">\t</span><span class="s1">New Energy</span><span class="se">\t</span><span class="s1">accepted</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp_clones</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">clone_lammps</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numtrials</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_name</span> <span class="o">=</span> <span class="s2">&quot;Regrowth&quot;</span>

<div class="viewcode-block" id="CBMCRegrowth.select_random_molecule"><a class="viewcode-back" href="../move_class.html#move_class.CBMCRegrowth.select_random_molecule">[docs]</a>    <span class="k">def</span> <span class="nf">select_random_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selects a random elegible molecule (one with an anchor atom set) from the molecules provided by the Simulation object that the CBMCRegrowth object was passed in at initialization.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Random Elegible Molecule : Molecule</span>
<span class="sd">            A randomly chosen molecule from the list of elegible ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elegible_molecules</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">molecule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anchortype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">atomType</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">])]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">rnd</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">elegible_molecules</span><span class="p">))</span></div>

<div class="viewcode-block" id="CBMCRegrowth.set_anchor_atoms"><a class="viewcode-back" href="../move_class.html#move_class.CBMCRegrowth.set_anchor_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">set_anchor_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For every molecule in the Move&#39;s associated simulation the anchor atom is set to the anchortype associated with the CBMCRegrowth instance.  </span>
<span class="sd">        Any molecule that does not have an atom of type anchortype is skipped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">anchorIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">atomID</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomType</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">anchortype</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anchorIDs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">molecule</span><span class="o">.</span><span class="n">setAnchorAtom</span><span class="p">(</span><span class="n">anchorIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="CBMCRegrowth.select_index"><a class="viewcode-back" href="../move_class.html#move_class.CBMCRegrowth.select_index">[docs]</a>    <span class="k">def</span> <span class="nf">select_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selects a random index of a molecule ranging from 3 to the final index.  The index selection starts at 3 as no dihedral rotation does not move any atoms with index less than 3.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molecule : Molecule</span>
<span class="sd">            The Molecule objectone wishes to select a ranomd index from.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        index : int</span>
<span class="sd">            A random index from 3 to length of molecule.      </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">rnd</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)))</span></div>

<div class="viewcode-block" id="CBMCRegrowth.select_dih_angles"><a class="viewcode-back" href="../move_class.html#move_class.CBMCRegrowth.select_dih_angles">[docs]</a>    <span class="k">def</span> <span class="nf">select_dih_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dih_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns numtrials number of dihedral angles with probability given by the PDF given by the boltzmann distribution determined by the temperature and the dihedral forcefield.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dih_type : int</span>
<span class="sd">            An integer which corresponds to the type of Dihedral one wishes to samples.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        trial_dih_angles : Numpy array of floats</span>
<span class="sd">            An array of floats which correspond to the selected dihedral angles in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">force_field</span> <span class="o">=</span> <span class="p">[</span><span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_ffs</span> <span class="k">if</span> <span class="n">ff</span><span class="o">.</span><span class="n">dihedral_type</span><span class="o">==</span><span class="n">dih_type</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">(</span><span class="n">thetas</span><span class="p">,</span><span class="n">ff_pdf</span><span class="p">)</span> <span class="o">=</span> <span class="n">force_field</span><span class="o">.</span><span class="n">get_pdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">dtheta</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thetas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">trial_dih_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numtrials</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">ff_pdf</span><span class="o">*</span><span class="n">dtheta</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">trial_dih_angles</span><span class="p">)</span></div>

<div class="viewcode-block" id="CBMCRegrowth.parallel_evaluate_energies"><a class="viewcode-back" href="../move_class.html#move_class.CBMCRegrowth.parallel_evaluate_energies">[docs]</a>    <span class="k">def</span> <span class="nf">parallel_evaluate_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">rotations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluates the pair potential energy of numtrials number of rotations about a the dihedral at the given molecule index and returns the result.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molecule : Molecule</span>
<span class="sd">            The molecule that is currently being regrown</span>
<span class="sd">        index : int</span>
<span class="sd">            The index of the monomer in the molecular chain that is being rotated.</span>
<span class="sd">        rotations : float</span>
<span class="sd">            The degree of rotation of the dihedral in radians needed to reach each sample point for evaluation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        energies : float list</span>
<span class="sd">            A list of the pair potential energy for each rotation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#coords = [atom.position for atom in self.simulation.atomlist]</span>
        <span class="c1">#num_atoms = self.simulation.atoms.shape[0]</span>
        <span class="c1">#eval_coords = np.empty((self.numtrials,num_atoms,3))</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">rotation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rotations</span><span class="p">):</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">rotateDihedral</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">rotation</span><span class="p">)</span>
            <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_atom_coords</span><span class="p">())</span>
            <span class="c1">#self.simulation.update_clone_coord(self.lmp_clones[i],atom_coords)</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">rotateDihedral</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="o">-</span><span class="n">rotation</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">parallel_pair_PE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmp_clones</span><span class="p">,</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">energy</span> <span class="k">for</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">]))</span></div>
        



<div class="viewcode-block" id="CBMCRegrowth.evaluate_energies"><a class="viewcode-back" href="../move_class.html#move_class.CBMCRegrowth.evaluate_energies">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">rotations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evluates the pair energy of the system for each of the given dihedral rotations at the specified index.  For these enegies to be consistent with CBMC all atoms past the index should be turned off with turn_off_molecule_atoms.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molecule : Molecule</span>
<span class="sd">            The molecule on which the dihedral rotations will be carried out</span>
<span class="sd">        index : int</span>
<span class="sd">            The index of the atom that is in the last position of the dihedral to be rotated.</span>
<span class="sd">        rotations : list of floats</span>
<span class="sd">            A list of floats which represent the desired rotation from the current dihedral angle in Radians.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        energies : Numpy array of floats</span>
<span class="sd">            An array of the pair energy for each of the specified rotations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numtrials</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">rotation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rotations</span><span class="p">):</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">rotateDihedral</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">rotation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">update_coords</span><span class="p">()</span>
            <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_pair_PE</span><span class="p">()</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">rotateDihedral</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="o">-</span><span class="n">rotation</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">turn_off_molecule_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">):</span> 
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;=</span><span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">turn_on_all_atoms</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">indices_to_turn_off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">getAtomByMolIndex</span><span class="p">,</span><span class="n">indices_to_turn_off</span><span class="p">)</span>
        <span class="n">atomIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">atomID</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">turn_off_atoms</span><span class="p">(</span><span class="n">atomIDs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate_trial_rotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">dihedral</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">index2dihedral</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_dih_angles</span><span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">dihType</span><span class="p">)</span>
        <span class="n">theta0</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">getDihedralAngle</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span>
        <span class="n">rotations</span> <span class="o">=</span> <span class="n">thetas</span><span class="o">-</span><span class="n">theta0</span>
        <span class="k">if</span> <span class="n">keep_original</span><span class="p">:</span>
            <span class="n">rotations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turn_off_molecule_atoms</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">update_coords</span><span class="p">()</span>
        <span class="n">initial_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_pair_PE</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turn_off_molecule_atoms</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_evaluate_energies</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">rotations</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_energies</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">rotations</span><span class="p">)</span>
        <span class="n">log_rosen_weight</span> <span class="o">=</span> <span class="n">scm</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">energies</span><span class="o">-</span><span class="n">initial_energy</span><span class="p">))</span>
        <span class="n">log_norm_probs</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">energies</span><span class="o">-</span><span class="n">initial_energy</span><span class="p">)</span><span class="o">-</span><span class="n">log_rosen_weight</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">selected_rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">rotations</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_norm_probs</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Probabilities of trial rotations do not sum to 1&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">log_rosen_weight</span><span class="p">,</span><span class="n">selected_rotation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">regrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">total_log_rosen_weight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>             
            <span class="bp">self</span><span class="o">.</span><span class="n">turn_off_molecule_atoms</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">(</span><span class="n">log_step_weight</span><span class="p">,</span><span class="n">selected_rotation</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_trial_rotations</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">keep_original</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">keep_original</span> <span class="k">else</span> <span class="n">selected_rotation</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">rotateDihedral</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">rotation</span><span class="p">)</span>
            <span class="n">total_log_rosen_weight</span><span class="o">+=</span><span class="n">log_step_weight</span>
        <span class="k">return</span> <span class="n">total_log_rosen_weight</span>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_random_molecule</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_index</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span> 
        <span class="n">log_Wo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regrow</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">keep_original</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log_Wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regrow</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_Wf</span><span class="o">-</span><span class="n">log_Wo</span><span class="p">))</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">probability</span><span class="o">&gt;</span><span class="n">rnd</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">log_Wo</span><span class="o">==</span><span class="kc">False</span> <span class="ow">or</span> <span class="n">log_Wf</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">accepted</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">update_coords</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_moves</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span><span class="n">accepted</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_accepted</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span></div>


<div class="viewcode-block" id="CBMCSwap"><a class="viewcode-back" href="../move_class.html#move_class.CBMCSwap">[docs]</a><span class="k">class</span> <span class="nc">CBMCSwap</span><span class="p">(</span><span class="n">CBMCRegrowth</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">simulation</span><span class="p">,</span><span class="n">anchortype</span><span class="p">,</span><span class="n">type_lengths</span><span class="p">,</span><span class="n">starting_index</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">numtrials</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CBMCSwap</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span><span class="n">anchortype</span><span class="p">,</span><span class="n">numtrials</span><span class="p">,</span><span class="n">parallel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starting_index</span><span class="o">=</span><span class="n">starting_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type1_numatoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type2_numatoms</span> <span class="o">=</span> <span class="n">type_lengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_name</span><span class="o">=</span><span class="s2">&quot;CBMCSwap&quot;</span>
    
    <span class="k">def</span> <span class="nf">align_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule1</span><span class="p">,</span><span class="n">molecule2</span><span class="p">):</span>
        <span class="n">molecule1_vector</span> <span class="o">=</span> <span class="n">molecule1</span><span class="o">.</span><span class="n">get_com</span><span class="p">()</span><span class="o">-</span><span class="n">molecule1</span><span class="o">.</span><span class="n">anchorAtom</span><span class="o">.</span><span class="n">position</span>
        <span class="n">molecule2_vector</span> <span class="o">=</span> <span class="n">molecule2</span><span class="o">.</span><span class="n">get_com</span><span class="p">()</span><span class="o">-</span><span class="n">molecule2</span><span class="o">.</span><span class="n">anchorAtom</span><span class="o">.</span><span class="n">position</span>
        <span class="n">molecule1</span><span class="o">.</span><span class="n">align_to_vector</span><span class="p">(</span><span class="n">molecule2_vector</span><span class="p">)</span>
        <span class="n">molecule2</span><span class="o">.</span><span class="n">align_to_vector</span><span class="p">(</span><span class="n">molecule1_vector</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">swap_anchor_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule1</span><span class="p">,</span><span class="n">molecule2</span><span class="p">):</span>
        <span class="n">anchor_atom1</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule1</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomType</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchortype</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">anchor_atom2</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule2</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomType</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchortype</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">move1</span> <span class="o">=</span> <span class="n">anchor_atom2</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">anchor_atom1</span><span class="o">.</span><span class="n">position</span>
        <span class="n">move2</span> <span class="o">=</span> <span class="n">anchor_atom1</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">anchor_atom2</span><span class="o">.</span><span class="n">position</span>
        <span class="n">molecule1</span><span class="o">.</span><span class="n">move_atoms</span><span class="p">(</span><span class="n">move1</span><span class="p">)</span>
        <span class="n">molecule2</span><span class="o">.</span><span class="n">move_atoms</span><span class="p">(</span><span class="n">move2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">update_coords</span><span class="p">()</span>

<div class="viewcode-block" id="CBMCSwap.align_mol_to_positions"><a class="viewcode-back" href="../move_class.html#move_class.CBMCSwap.align_mol_to_positions">[docs]</a>    <span class="k">def</span> <span class="nf">align_mol_to_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mol</span><span class="p">,</span><span class="n">positions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;swap_atom1_positions = np.copy(np.array([mol1.getAtomByMolIndex(i).position for i in range(0,index+1)]))</span>
<span class="sd">        swap_atom2_positions = np.copy(np.array([mol2.getAtomByMolIndex(i).position for i in range(0,index+1)]))</span>
<span class="sd">        anchor_distance = np.copy(mol1.getAtomByMolIndex(0).position - mol2.getAtomByMolIndex(0).position)</span>

<span class="sd">        for i in range(index+1):</span>
<span class="sd">            move1 = swap_atom2_positions[i]-mol1.getAtomByMolIndex(i).position</span>
<span class="sd">            move2 = swap_atom1_positions[i]-mol2.getAtomByMolIndex(i).position</span>
<span class="sd">            mol1.move_atoms_by_index(move1,i)</span>
<span class="sd">            mol2.move_atoms_by_index(move2,i)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">position</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">positions</span><span class="p">):</span>
            <span class="n">move</span> <span class="o">=</span> <span class="n">position</span><span class="o">-</span><span class="n">mol</span><span class="o">.</span><span class="n">getAtomByMolIndex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">position</span>
            <span class="n">mol</span><span class="o">.</span><span class="n">move_atoms_by_index</span><span class="p">(</span><span class="n">move</span><span class="p">,</span><span class="n">i</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">swap_molecule_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mol1</span><span class="p">,</span><span class="n">mol2</span><span class="p">):</span>
        <span class="n">positions_mol1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol1</span><span class="o">.</span><span class="n">getAtomByMolIndex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starting_index</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span>
        <span class="n">positions_mol2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mol2</span><span class="o">.</span><span class="n">getAtomByMolIndex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starting_index</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_anchor_positions</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span><span class="n">mol2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_molecules</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span><span class="n">mol2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_mol_to_positions</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span><span class="n">positions_mol2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_mol_to_positions</span><span class="p">(</span><span class="n">mol2</span><span class="p">,</span><span class="n">positions_mol1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">update_coords</span><span class="p">()</span>
         

<div class="viewcode-block" id="CBMCSwap.select_random_molecules"><a class="viewcode-back" href="../move_class.html#move_class.CBMCSwap.select_random_molecules">[docs]</a>    <span class="k">def</span> <span class="nf">select_random_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selects a random elegible molecule (one with an anchor atom set) from the molecules provided by the Simulation object that the CBMCRegrowth object was passed in at initialization.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Random Elegible Molecule : Molecule</span>
<span class="sd">            A randomly chosen molecule from the list of elegible ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">type1_molecules</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">molecule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">type1_numatoms</span><span class="p">]</span>
        <span class="n">type2_molecules</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">molecule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">type2_numatoms</span><span class="p">]</span>
        <span class="n">random_mol_type1</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">type1_molecules</span><span class="p">)</span>
        <span class="n">random_mol_type2</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">type2_molecules</span><span class="p">)</span>
        <span class="k">return</span><span class="p">((</span><span class="n">random_mol_type1</span><span class="p">,</span><span class="n">random_mol_type2</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mol1</span><span class="p">,</span><span class="n">mol2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_random_molecules</span><span class="p">()</span>
        <span class="n">log_Wo_chain1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regrow</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">starting_index</span><span class="p">,</span><span class="n">keep_original</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log_Wo_chain2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regrow</span><span class="p">(</span><span class="n">mol2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">starting_index</span><span class="p">,</span><span class="n">keep_original</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_molecule_positions</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span><span class="n">mol2</span><span class="p">)</span>
        <span class="n">log_Wf_chain1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regrow</span><span class="p">(</span><span class="n">mol1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">starting_index</span><span class="p">,</span><span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">log_Wf_chain2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regrow</span><span class="p">(</span><span class="n">mol2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">starting_index</span><span class="p">,</span><span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_Wf_chain1</span><span class="o">+</span><span class="n">log_Wf_chain2</span><span class="o">-</span><span class="p">(</span><span class="n">log_Wo_chain1</span><span class="o">+</span><span class="n">log_Wo_chain2</span><span class="p">)))</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">probability</span><span class="o">&gt;</span><span class="n">rnd</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">log_Wo_chain1</span><span class="p">,</span><span class="n">log_Wo_chain2</span><span class="p">,</span><span class="n">log_Wf_chain2</span><span class="p">,</span><span class="n">log_Wf_chain1</span><span class="p">]):</span>
            <span class="n">accepted</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">update_coords</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_moves</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span><span class="n">accepted</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_accepted</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span></div>


<div class="viewcode-block" id="TranslationMove"><a class="viewcode-back" href="../move_class.html#move_class.TranslationMove">[docs]</a><span class="k">class</span> <span class="nc">TranslationMove</span><span class="p">(</span><span class="n">Move</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">simulation</span><span class="p">,</span><span class="n">max_disp</span><span class="p">,</span><span class="n">stationary_types</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TranslationMove</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_disp</span> <span class="o">=</span> <span class="n">max_disp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stationary_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stationary_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_name</span> <span class="o">=</span> <span class="s2">&quot;Translation&quot;</span>

    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule</span><span class="p">,</span><span class="n">displacement</span><span class="p">):</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">move_atoms</span><span class="p">(</span><span class="n">displacement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">update_coords</span><span class="p">()</span>

<div class="viewcode-block" id="TranslationMove.select_random_molecule"><a class="viewcode-back" href="../move_class.html#move_class.TranslationMove.select_random_molecule">[docs]</a>    <span class="k">def</span> <span class="nf">select_random_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selects a random elegible molecule (one with no atoms of the type specified by stationary_types) from the molecules provided by the Simulation object that the CBMCRegrowth object was passed in at initialization.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Random Elegible Molecule : Molecule</span>
<span class="sd">            A randomly chosen molecule from the list of elegible ones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elegible_molecules</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">molecule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stationary_types</span><span class="o">.</span><span class="n">intersection</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">atomType</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">]))]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">rnd</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">elegible_molecules</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">get_random_move</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">rnd</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rnd</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_disp</span><span class="o">*</span><span class="n">rnd</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)]))</span>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">old_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_total_PE</span><span class="p">()</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_random_molecule</span><span class="p">()</span>
        <span class="n">displacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_move</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="n">displacement</span><span class="p">)</span>
        <span class="n">new_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_total_PE</span><span class="p">()</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">new_energy</span><span class="o">-</span><span class="n">old_energy</span><span class="p">)))</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">probability</span><span class="o">&gt;</span><span class="n">rnd</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_moves</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span><span class="n">accepted</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_accepted</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span></div>


<div class="viewcode-block" id="SwapMove"><a class="viewcode-back" href="../move_class.html#move_class.SwapMove">[docs]</a><span class="k">class</span> <span class="nc">SwapMove</span><span class="p">(</span><span class="n">Move</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">simulation</span><span class="p">,</span><span class="n">anchortype</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SwapMove</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anchorType</span> <span class="o">=</span> <span class="n">anchortype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_name</span> <span class="o">=</span> <span class="s2">&quot;Swap&quot;</span>

    <span class="k">def</span> <span class="nf">get_random_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">elegible_molecules</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">molecule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anchorType</span> <span class="ow">in</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">atomType</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">])]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">elegible_molecules</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">swap_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule1</span><span class="p">,</span><span class="n">molecule2</span><span class="p">):</span>
        <span class="n">anchor_atom1</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule1</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomType</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchorType</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">anchor_atom2</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule2</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomType</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchorType</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">move1</span> <span class="o">=</span> <span class="n">anchor_atom2</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">anchor_atom1</span><span class="o">.</span><span class="n">position</span>
        <span class="n">move2</span> <span class="o">=</span> <span class="n">anchor_atom1</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">anchor_atom2</span><span class="o">.</span><span class="n">position</span>
        <span class="n">molecule1</span><span class="o">.</span><span class="n">move_atoms</span><span class="p">(</span><span class="n">move1</span><span class="p">)</span>
        <span class="n">molecule2</span><span class="o">.</span><span class="n">move_atoms</span><span class="p">(</span><span class="n">move2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">update_coords</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">align_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule1</span><span class="p">,</span><span class="n">molecule2</span><span class="p">):</span>
        <span class="n">molecule1_vector</span> <span class="o">=</span> <span class="n">molecule1</span><span class="o">.</span><span class="n">get_com</span><span class="p">()</span><span class="o">-</span><span class="n">molecule1</span><span class="o">.</span><span class="n">anchorAtom</span><span class="o">.</span><span class="n">position</span>
        <span class="n">molecule2_vector</span> <span class="o">=</span> <span class="n">molecule2</span><span class="o">.</span><span class="n">get_com</span><span class="p">()</span><span class="o">-</span><span class="n">molecule2</span><span class="o">.</span><span class="n">anchorAtom</span><span class="o">.</span><span class="n">position</span>
        <span class="n">molecule1</span><span class="o">.</span><span class="n">align_to_vector</span><span class="p">(</span><span class="n">molecule2_vector</span><span class="p">)</span>
        <span class="n">molecule2</span><span class="o">.</span><span class="n">align_to_vector</span><span class="p">(</span><span class="n">molecule1_vector</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">old_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_total_PE</span><span class="p">()</span>
        <span class="n">molecule1</span><span class="p">,</span><span class="n">molecule2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_molecules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_molecules</span><span class="p">(</span><span class="n">molecule1</span><span class="p">,</span><span class="n">molecule2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_positions</span><span class="p">(</span><span class="n">molecule1</span><span class="p">,</span><span class="n">molecule2</span><span class="p">)</span>
        <span class="n">new_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_total_PE</span><span class="p">()</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">new_energy</span><span class="o">-</span><span class="n">old_energy</span><span class="p">)))</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">probability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_moves</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">accepted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_accepted</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="RotationMove"><a class="viewcode-back" href="../move_class.html#move_class.RotationMove">[docs]</a><span class="k">class</span> <span class="nc">RotationMove</span><span class="p">(</span><span class="n">Move</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">simulation</span><span class="p">,</span><span class="n">anchortype</span><span class="p">,</span><span class="n">max_angle</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RotationMove</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anchorType</span> <span class="o">=</span> <span class="n">anchortype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_angle</span> <span class="o">=</span> <span class="n">max_angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_name</span> <span class="o">=</span> <span class="s2">&quot;Rotation&quot;</span>

    <span class="k">def</span> <span class="nf">get_random_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">elegible_molecules</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">molecule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anchorType</span> <span class="ow">in</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">atomType</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">])]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">elegible_molecules</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_molecule_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">get_com</span><span class="p">()</span><span class="o">-</span><span class="n">molecule</span><span class="o">.</span><span class="n">anchorAtom</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_random_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x_axis</span><span class="p">,</span><span class="n">y_axis</span><span class="p">,</span><span class="n">z_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">random_axis</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">x_axis</span><span class="p">,</span><span class="n">y_axis</span><span class="p">,</span><span class="n">z_axis</span><span class="p">])</span>
        <span class="k">return</span><span class="p">(</span><span class="n">random_axis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_random_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">magnitude</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angle</span><span class="p">)</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span><span class="p">(</span><span class="n">magnitude</span><span class="o">*</span><span class="n">sign</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rotate_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">molecule</span><span class="p">):</span>
        <span class="n">molecule_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_molecule_vector</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
        <span class="n">random_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_axis</span><span class="p">()</span>
        <span class="n">random_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_angle</span><span class="p">()</span>
        <span class="n">new_vector</span> <span class="o">=</span> <span class="n">molc</span><span class="o">.</span><span class="n">rot_quat</span><span class="p">(</span><span class="n">molecule_vector</span><span class="p">,</span><span class="n">random_angle</span><span class="p">,</span><span class="n">random_axis</span><span class="p">)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">align_to_vector</span><span class="p">(</span><span class="n">new_vector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">update_coords</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">old_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_total_PE</span><span class="p">()</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_molecule</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotate_molecule</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
        <span class="n">new_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">get_total_PE</span><span class="p">()</span>
        <span class="n">probability</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">new_energy</span><span class="o">-</span><span class="n">old_energy</span><span class="p">)))</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">probability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_moves</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">accepted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_accepted</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span></div>

















</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Steven Merz

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>